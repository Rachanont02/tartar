<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- iOS icon -->
    <link rel="manifest" href="manifest.json?v=2">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <title>TarTar</title>

    <!-- PWA -->
    <meta name="theme-color" content="#EEEFF3">

    <!-- iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="TarTar">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <header>
      <h1>TarTar ✨</h1>
      <p>บันทึกความทรงจำของคู่เรา และเป็นผู้ช่วยการเดินทาง</p>
    </header>

    <main>
      <section class="card">
        <h2>สถานะแอป</h2>
        <p id="status">กำลังตรวจสอบ...</p>
        <div class="actions">
          <button id="cache-btn">โหลดไฟล์ล่วงหน้า</button>
          <button id="clear-cache-btn">ล้าง cache</button>
        </div>
      </section>

      <section class="card">
        <h2>รายการทริป</h2>
        <ul id="trip-list"></ul>
      </section>
    </main>

    <footer>© 2025 Fillus</footer>
    <script src="app.js "></script>
    <script type="module">
      import { listTrips, addTrip, deleteTrip } from './api.js';
    
      const listEl = document.getElementById('trip-list');
      const statusEl = document.getElementById('status');
    
      const fmt = (iso) =>
        iso ? new Date(iso).toLocaleDateString('th-TH', { day:'numeric', month:'short', year:'numeric' }) : '';
    
      const esc = (s='') => s
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    
      async function refreshList(){
        statusEl.textContent = 'กำลังโหลดรายการ...';
        try{
          const rows = await listTrips();
          if (!rows.length){
            listEl.innerHTML = '<li>ยังไม่มีทริป</li>';
          } else {
            listEl.innerHTML = rows.map(r => `
              <li class="trip" data-id="${esc(r.id)}">
                <div class="trip-line">
                  <div class="trip-info">
                    <strong>${esc(r.title || '')}</strong>
                    <small>(${fmt(r.start_date)} – ${fmt(r.end_date)})</small><br>
                    <small>${esc(r.notes || '')}</small>
                  </div>
                  <button class="btn-delete" data-del="${esc(r.id)}">ลบ</button>
                </div>
              </li>
            `).join('');
          }
          statusEl.textContent = 'โหลดสำเร็จ ✅';
        }catch(err){
          console.error(err);
          statusEl.textContent = 'โหลดไม่สำเร็จ ❌';
          listEl.innerHTML = '<li>ดึงข้อมูลไม่สำเร็จ</li>';
        }
      }
    
      // ลบด้วย event delegation (คลิกปุ่มลบของรายการไหนก็จับได้)
      listEl.addEventListener('click', async (e) => {
        const id = e.target?.dataset?.del;
        if (!id) return;
        if (!confirm('ยืนยันลบทริปนี้?')) return;
    
        try{
          e.target.disabled = true;
          e.target.textContent = 'กำลังลบ...';
          await deleteTrip(id);
          await refreshList();
        }catch(err){
          console.error(err);
          alert('ลบไม่สำเร็จ');
        }finally{
          e.target.disabled = false;
          e.target.textContent = 'ลบ';
        }
      });
    
      // เรียกครั้งแรก
      refreshList();
    </script>
    
  </body>

</html>
